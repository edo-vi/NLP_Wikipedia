import numpy as np
import pandas as pd
import requests
import os
import re
import nltk
from nltk.lm import NgramCounter
from nltk.util import ngrams
from collections import Counter

from MyCounter import MyCounter

np.random.seed(10)
url = "https://en.wikipedia.org/w/api.php"
m_ids = [
    12664718,
    32265516,
    7687502,
    7643643,
    63687773,
    2410864,
    16818556,
    12123403,
    38088694,
    11789193,
    39762849,
    14820213,
    4325643,
    7324090,
    16556916,
    34677623,
    34306601,
    9128972,
    22077494,
    40703649,
    35695335,
    10324589,
    52823792,
    39307595,
    36732930,
    25258088,
    13506609,
    29830233,
    27387114,
    36851711,
    9298680,
    17835748,
    5312063,
    51452660,
    6653275,
    27232632,
    11157360,
    1562717,
    23413270,
    11064985,
    37910936,
    10527532,
    16386089,
    5835531,
    13252823,
    3466967,
    8993455,
    33840728,
    25755794,
    919125,
    3507309,
    56057194,
    5697015,
    32078680,
    12173489,
    10543241,
    18662881,
    35035352,
    11385740,
    1410386,
    2165494,
    59055215,
    69563062,
    41225619,
    1130504,
    300772,
    27386995,
    48029696,
    48584298,
    15104461,
    34976715,
    39240276,
    10227263,
    7247458,
    6265425,
    39536693,
    58157868,
    26777771,
    37536553,
    18090607,
    74895888,
    1130546,
    223111,
    17538021,
    2618516,
    35834433,
    3518067,
    6685906,
    54404726,
    2575117,
    19383745,
    23714060,
    22488521,
    1060461,
    15696380,
    59555366,
    23451032,
    35667270,
    15093896,
    526596,
    3640605,
    7703176,
    65243878,
    1410327,
    10110134,
    53248586,
    5846118,
    38474884,
    24032119,
    1130476,
    54317251,
    1130479,
    53068252,
    3837225,
    11526568,
    30873290,
    3887850,
    31786777,
    9533319,
    7332373,
    919914,
    10445988,
    1424143,
    1130490,
    26098083,
    40690322,
    5826435,
    4565578,
    10013,
    54385959,
    50892477,
    46702056,
    37329385,
    27287411,
    13041496,
    237721,
    43051635,
    62792073,
    43698229,
    70379793,
    18137793,
    71487115,
    83877,
    18660824,
    28539183,
    47763053,
    21148859,
    22144213,
    40419859,
    40440492,
    31347277,
    61735633,
    16344646,
    70379446,
    935486,
    16036651,
    16067905,
    8625779,
    46603974,
    19560460,
    37953948,
    3089877,
    33915432,
    71872518,
    935451,
    24426070,
    26349710,
    7176424,
    2622311,
    15219191,
    24848067,
    44301349,
    30688232,
    30427095,
    31359857,
    70374700,
    39963253,
    17323880,
    38526066,
    17719645,
    16040223,
    54414218,
    37248915,
    10420896,
    3740763,
    5669348,
    317511,
    46303046,
    73792936,
    27942902,
    39893187,
    72468219,
    3952518,
    61525916,
    10304186,
    4765289,
    32854110,
    32812498,
    5551093,
    4861880,
    14883919,
    31591137,
    2439204,
    33909875,
    32850190,
    33354679,
    1607085,
    24120957,
    32999836,
    69841931,
    6645369,
    52387136,
    55554061,
    5484891,
    4079053,
    35539271,
    1899507,
    41864077,
    52682951,
    17471627,
    70827899,
    8002693,
    8002789,
    3882906,
    17542723,
    5143229,
    6786575,
    26488003,
    32997558,
    8156682,
    8155942,
    11721871,
    10066229,
    11094380,
    1370289,
    4871848,
    14892880,
    22314141,
    4870889,
    40542571,
    42269169,
    4097229,
    44487472,
    4098644,
    29897966,
    49782137,
    67445372,
    2703534,
    55168830,
    16961703,
    4376466,
    3372919,
    44290674,
    69780644,
    646573,
    18659643,
    66338001,
    42649432,
    3902650,
    31881995,
    13765537,
    3886974,
    10034950,
    43565534,
    12237355,
    4288821,
    43158726,
    2167412,
    33373214,
    69756391,
    4031180,
    10405105,
    8466542,
    63098188,
    17495225,
    31204957,
    3823715,
    6866234,
    27936239,
    35017862,
    52103535,
    22168869,
    6868776,
    6868712,
    18248420,
    33679848,
    25000656,
    8173473,
    46440709,
    46443694,
    46499719,
    33076141,
    58012433,
    33331852,
    33076955,
    2015788,
    2186220,
    40913990,
    5316548,
    44186297,
    17608549,
    2201908,
    5335383,
    1532332,
    52018560,
    4280266,
    20819509,
    10612706,
    17035364,
    33102664,
    33354427,
    33138964,
    33354565,
    2056625,
    25367107,
    74947786,
    21952946,
    33149349,
    35539273,
    2947580,
    46864621,
    3914815,
    10616040,
    49066893,
    5446800,
    25336375,
    9646417,
    11648613,
    33387123,
    3999078,
    68813943,
    22635668,
    27937615,
    4311925,
    12365985,
    2329492,
    16073320,
    2201782,
    23088813,
    16896801,
    33331511,
    3498765,
    32841338,
    46295506,
    23847326,
    35539275,
    10749768,
    38532630,
    2015725,
    61233629,
    56180116,
    43104215,
    13276327,
    44884825,
    30748898,
    317507,
    3914909,
    13436654,
    10139817,
    25464216,
    32473,
    2114227,
    10275355,
    1692847,
    11026468,
    11365279,
    1482042,
    5703563,
    40616254,
    30540048,
    46223194,
    1281756,
    4134885,
    67848628,
    40606087,
    63842993,
    59951553,
    25530727,
    11175093,
    64649692,
    21977757,
    68505120,
    87175,
    21862169,
    56378847,
    284029,
    10856772,
    13008203,
    40615969,
    3976905,
    61015976,
    66012376,
    40616100,
    16918530,
    18610161,
    14414683,
    951614,
    69518370,
    65368595,
    21291825,
    13107678,
    9901652,
    22826968,
    22192759,
    42863440,
    37494278,
    3972534,
    29252190,
    19364010,
    47393255,
    3296243,
    1005946,
    14747754,
    65367112,
    66655182,
    44441540,
    69627157,
    1065730,
    34564790,
    22613602,
    67757719,
    35926498,
    61465449,
    10022123,
    69150068,
    32093248,
    66213053,
    67123375,
    68449046,
    16106907,
    32279306,
    67864558,
    66893619,
    6723049,
    32241450,
    39968360,
    32165548,
    5206174,
    37956283,
    42448124,
    70605039,
    30031585,
    54393139,
    56233051,
    56746806,
    58516158,
    60753035,
    58436923,
    59397759,
    63769908,
    71502309,
    57371426,
    58011203,
    55586589,
    39532251,
    62883347,
    57491940,
]
non_m_ids = [
    66188994,
    118474,
    8191076,
    532476,
    340510,
    5823212,
    18836,
    103155,
    3328588,
    7174,
    14173752,
    57491343,
    59329248,
    25046128,
    50700186,
    27606636,
    19257688,
    70913289,
    43692456,
    11977904,
    29570293,
    40182149,
    10938364,
    62483077,
    68092158,
    22156167,
    20756311,
    68359750,
    39403716,
    41952735,
    43401246,
    63631356,
    32544555,
    8856044,
    45498419,
    989968,
    188168,
    68027374,
    12454750,
    51781199,
    11595620,
    28381078,
    5808948,
    4175228,
    10088016,
    562583,
    55371131,
    64465154,
    52627686,
    66763727,
    722374,
    21981132,
    8961575,
    42429912,
    42429675,
    58221338,
    53290497,
    36807165,
    7251223,
    33252958,
    51472964,
    44022067,
    62489620,
    58247763,
    62433972,
    36082813,
    43740334,
    36306767,
    1244693,
    74911613,
    41334623,
    25136,
    852480,
    69864289,
    40056381,
    74558667,
    3234630,
    43417461,
    440393,
    74273322,
    50943294,
    48110,
    37083057,
    30858332,
    33893690,
    50741246,
    27887526,
    3872234,
    69833142,
    68845945,
    69070022,
    242315,
    70093812,
    6273713,
    22141996,
    1191544,
    46751769,
    50345901,
    592392,
    53880545,
    21259396,
    1975092,
    37679646,
    8010462,
    54116315,
    55762330,
    12719721,
    48120778,
    34956958,
    6323098,
    8099572,
    18400571,
    25172837,
    58956661,
    73499130,
    16677153,
    1690046,
    956795,
    47484119,
    18472072,
    14248637,
    426484,
    29997493,
    29663719,
    20871496,
    10967568,
    48069054,
    62521794,
    70018114,
    39748081,
    498971,
    37679667,
    993125,
    31240382,
    18801301,
    52059694,
    51676196,
    55571473,
    61593115,
    848317,
    51461892,
    3536209,
    2958015,
    55962927,
    50785023,
    31641770,
    21666977,
    55817338,
    72135653,
    9755539,
    14842794,
    16707204,
    55941593,
    1134562,
    72166473,
    2968419,
    6216,
    16300571,
    3951220,
    2712053,
    404048,
    263636,
    1124646,
    56221934,
    8919856,
    952926,
    33034640,
    433005,
    66205491,
    13659583,
    64688191,
    62683332,
    4513331,
    1742461,
    351887,
    44636570,
    3547088,
    72607666,
    70993391,
    73501753,
    32237314,
    46181931,
    47937215,
    74185828,
    12476035,
    404037,
    23569174,
    4522868,
    2685999,
    30405742,
    8434470,
    516138,
    73761282,
    66704693,
    2548050,
    54245,
    74958182,
    30299,
    21391751,
    430976,
    12207,
    14343000,
    71759612,
    48215783,
    53561288,
    5571005,
    69460867,
    69266674,
    6460996,
    56078430,
    3069483,
    24503316,
    49073376,
    65029937,
    1840762,
    75030221,
    62902519,
    44208525,
    17611421,
    27290438,
    78534,
    898161,
    69822725,
    8245348,
    62191085,
    57192745,
    5904871,
    53580439,
    61588611,
    60557698,
    363092,
    2886641,
    55146723,
    17709742,
    67006520,
    61481498,
    64041906,
    4127809,
    57837450,
    27425975,
    44007076,
    48043351,
    59969032,
    57352318,
    8443072,
    67525526,
    4647646,
    49505197,
    70673979,
    40914232,
    27667,
    63192624,
    3091760,
    71698731,
    71498836,
    53977963,
    62980659,
    28244920,
    1478662,
    69276509,
    9332507,
    62996247,
    69600247,
    64768088,
    67654734,
    33739475,
    72545591,
    70476313,
    208999,
    8994982,
    70126407,
    3037867,
    4218673,
    41071610,
    3054853,
    32172794,
    34043,
    18963870,
    18345,
    1419427,
    297267,
    470031,
    13557443,
    33563052,
    649720,
    37389994,
    27691317,
    13607556,
    42431426,
    46382079,
    24145205,
    25590689,
    19284595,
    20395887,
    70575453,
    47243509,
    24616694,
    291229,
    2234574,
    58455529,
    181117,
    24587014,
    1001254,
    17046772,
    1851712,
    983787,
    15944015,
    455547,
    62712050,
    3837845,
    350381,
    722906,
    21424551,
    73826791,
    4137340,
    2119393,
    646598,
    8307635,
    30792823,
    62971006,
    1123773,
    26184869,
    54840463,
    39127991,
    70174,
    718763,
    75081155,
    2588267,
    46673516,
    2110568,
    97234,
    70991052,
    7410249,
    22926,
    20959122,
    1523896,
    23529,
    72772900,
    63224981,
    13666328,
    2694761,
    12749679,
    17569583,
    372984,
    302445,
    24991288,
    31896902,
    13878013,
    4444344,
    32923,
    19810565,
    90138,
    465480,
    38024285,
    6824237,
    30999254,
    13333913,
    53004548,
    46419264,
    57512513,
    5728552,
    39563457,
    25776777,
    54072382,
    39895391,
    47123596,
    25495107,
    1117386,
    20593859,
    37043764,
    72682229,
    22805820,
    25508360,
    27812753,
    52017909,
    39728112,
    7183413,
    621946,
    5832437,
    21279463,
    2200600,
    951649,
    33957251,
    24220268,
    27314675,
    16189184,
    66401997,
    5822209,
    4943880,
    24818668,
    27705110,
    6420600,
    10276033,
    21148945,
    2909033,
    47123594,
    28726646,
    53034676,
    36979916,
]
print(len(m_ids), len(non_m_ids))


def produce_documents(ids, kind):
    for id in ids:
        new_params = {
            "format": "json",
            "action": "query",
            "prop": "revisions",
            "rvslots": "*",
            "rvprop": "content",
            "redirects": 1,
            "pageids": id,
        }
        req = requests.get(url, new_params)
        try:
            title = req.json()["query"]["pages"][str(id)]["revisions"][0]["slots"][
                "main"
            ]["*"]
            with open(f"./documents/{kind}/{id}.txt", "w") as f:
                f.write(title)
        except:
            print(f"||Failed at id {id}||")


def clean_doc(string):
    string = re.sub("<ref.*?</ref>", "", string)  # removes refs
    string = re.sub("<ref.*?/>", "", string)  # idem
    string = re.sub("{.*?}", "", string)  # removes "{...}"
    string = re.sub(
        "\|.*\n?", "", string
    )  # removes lines starting with "|"" and continuing until the end
    string = re.sub("(Category).*\n?", "", string)
    string = re.sub("(thumb\|.*?\|)", "", string)  # removes "thumb|...|"
    string = re.sub(
        "(thumb)", "", string
    )  # removes "thumb" (canno easily distinguish all cases)
    string = re.sub(
        "\[\[.*?\|", "", string
    )  # removes links such as [[dieting|diet]], but only the first part (up until "|"), which is the link.
    string = re.sub(
        "[\[\[,\]\],{,},',#,=,\|]", "", string
    )  # removes all remaining bad characters: left out ]], [], {}, #, =, |
    string = re.sub("\\n", "\n", string)  # removes newlines
    return string


def clean_documents(folder):
    path = f"documents/{folder}"
    os.chdir(path)
    for file in os.listdir():
        # Check whether file is in text format or not
        if file.endswith(".txt"):
            file_path = f"{path}/{file}"

            # call read text file function
            print(file_path)
            new_lines = []
            with open(file, "r") as f:
                lines = f.readlines()
                for l in lines:
                    new_lines.append(clean_doc(l))
            f_path = file.split(".")[0]
            new_path = f"../{folder}_cleaned/{f_path}_c.txt"
            with open(new_path, "w") as fw:
                for nl in new_lines:
                    fw.write(nl)


def tokenize(text):
    return nltk.word_tokenize(text)


test_path = "/home/edoardo/nlp_wikipedia/documents/medicine_cleaned/10013_c.txt"
# produce_documents(m_ids, "non_medicine")
# clean_documents("non_medicine")
# nltk.download("punkt")

with open(test_path, "r") as f:
    tokens = []

    lines = f.readlines()
    for l in lines:
        tok = tokenize(l)
        tokens = tokens + tok

    # print(tokens)
    nltk.download("stopwords")
    counts = MyCounter(tokens)
    print(counts.c("and"))
    print(counts.c("Medicine"))
    print(counts.N())

    counts2 = counts.remove_stopwords()
    print(counts2.N())

    counts3 = counts2.stem()
    print(counts3.c("and"))
    print(counts3.c("Medicine"))

    # print(np.array(list(counts.values())).sum())
